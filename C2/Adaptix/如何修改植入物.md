## 修改 Beacon Agent 的特征

### 1. 编译标志配置

Beacon 使用了 OPSEC 友好的编译标志来减少特征:

关键的反检测编译选项包括:
- `BufferSecurityCheck=false` - 禁用缓冲区安全检查
- `ExceptionHandling=false` - 禁用异常处理
- `RuntimeLibrary=MultiThreaded` - 静态链接运行时
- `GenerateDebugInformation=false` - 不生成调试信息
- `IgnoreAllDefaultLibraries=true` - 忽略默认库链接

### 2. 输出格式选择

Beacon 支持多种输出格式,每种都有不同的检测特征:<cite></cite>

- **EXE** - 标准可执行文件
- **DLL** - 动态链接库,可用于 DLL 侧加载
- **Service** - Windows 服务可执行文件  
- **Shellcode** - 位置无关的 shellcode

### 3. 函数哈希混淆

Beacon 使用函数哈希来避免直接导入 API 函数名:

这些哈希值用于动态解析 API 函数,而不是在导入表中明文显示函数名。<cite></cite>

### 4. 通信协议自定义

您可以修改 HTTP/HTTPS 监听器的特征:<cite></cite>

- 自定义 User-Agent
- 自定义 URI 路径
- 自定义 HTTP 头
- 自定义响应页面模板

这些配置在生成 agent 时通过监听器配置文件传递。<cite></cite>

### 5. 配置文件选项

通过 `profile` 命令可以运行时修改 agent 行为:

- `killdate` - 设置自毁日期
- `workingtime` - 限制活动时间窗口
- `download.chunksize` - 修改下载块大小

## 修改 Gopher Agent 的特征

Gopher Agent 是 Go 编写的跨平台植入物,修改方式不同:<cite></cite>

### 1. 加密配置

Gopher 使用 AES 加密嵌入的配置文件,这使得静态分析更困难。<cite></cite>

### 2. 编译选项

Go 编译时可以使用以下选项减少特征:
- `-ldflags="-s -w"` - 去除符号表和调试信息
- `-trimpath` - 移除文件系统路径
- 使用 UPX 等工具压缩二进制文件

<cite></cite>

## Notes

这些修改主要针对静态检测。对于行为检测,您还需要考虑:
- 修改网络通信模式（sleep/jitter 时间）
- 使用自定义的加密算法替换 RC4
- 修改内存中的字符串和特征码
- 使用代码混淆工具

AdaptixC2 的插件架构允许您创建完全自定义的 agent 实现,这是最彻底的避免检测方法。

源代码位于 `Extenders/beacon_agent/src_beacon/` 和 `Extenders/gopher_agent/src_gopher/` 目录,您可以直接修改源码后重新编译。

### Citations

**File:** Extenders/beacon_agent/src_beacon/beacon/beacon.vcxproj (L217-220)
```text
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <WholeProgramOptimization>false</WholeProgramOptimization>
```

**File:** Extenders/beacon_agent/src_beacon/beacon/beacon.vcxproj (L238-252)
```text
      <PreprocessorDefinitions>BUILD_DLL;%(PreprocessorDefinitions)</PreprocessorDefinitions>
      <ConformanceMode>true</ConformanceMode>
      <ExceptionHandling>false</ExceptionHandling>
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <WholeProgramOptimization>false</WholeProgramOptimization>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>false</GenerateDebugInformation>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EntryPointSymbol>DllMain</EntryPointSymbol>
    </Link>
```

**File:** Extenders/beacon_agent/src_beacon/beacon/beacon.vcxproj (L263-274)
```text
      <RuntimeLibrary>MultiThreaded</RuntimeLibrary>
      <BufferSecurityCheck>false</BufferSecurityCheck>
      <WholeProgramOptimization>false</WholeProgramOptimization>
      <Optimization>Disabled</Optimization>
    </ClCompile>
    <Link>
      <SubSystem>Windows</SubSystem>
      <EnableCOMDATFolding>true</EnableCOMDATFolding>
      <OptimizeReferences>true</OptimizeReferences>
      <GenerateDebugInformation>false</GenerateDebugInformation>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <EntryPointSymbol>WinMain</EntryPointSymbol>
```

**File:** Extenders/beacon_agent/src_beacon/files/hashes.py (L156-171)
```python
BeaconInjectTemporaryProcess
BeaconSpawnTemporaryProcess
BeaconCleanupProcess
toWideChar
BeaconInformation
BeaconAddValue
BeaconGetValue
BeaconRemoveValue
LoadLibraryA
GetProcAddress
GetModuleHandleA
FreeLibrary
__C_specific_handler
AxAddScreenshot
AxDownloadMemory

```

**File:** Extenders/beacon_agent/ax_config.axs (L180-187)
```text
    let _cmd_profile_chunksize = ax.create_command("download.chunksize", "Change the exfiltrate data size for download request (default 128000)", "profile download.chunksize 512000", "Task: set download chunk size");
    _cmd_profile_chunksize.addArgInt("size", true);
    let _cmd_profile_killdate = ax.create_command("killdate", "Set the date and time for the beacon to stop working", "profile killdate 28.02.2030 12:34:00", "Task: set beacon's killdate");
    _cmd_profile_killdate.addArgString("datetime", true, "Datetime 'DD.MM.YYYY hh:mm:ss' in GMT format. Set 0 to disable the option");
    let _cmd_profile_workingtime = ax.create_command("workingtime", "Set the start and end time of the beacon activity", "profile workingtime 8:00-17:30", "Task: set beacon's workingtime");
    _cmd_profile_workingtime.addArgString("time", true, "Time interval in the format 'HH:mm(start)-HH:mm(end)'. Set 0 to disable the option");
    let cmd_profile = ax.create_command("profile", "Configure the payloads profile for current session");
    cmd_profile.addSubCommands([_cmd_profile_chunksize, _cmd_profile_killdate, _cmd_profile_workingtime]);
```

**File:** AdaptixServer/core/extender/ex_agent.go (L9-14)
```go
func (ex *AdaptixExtender) ExAgentGenerate(agentName string, config string, listenerWM string, listenerProfile []byte) ([]byte, string, error) {
	module, ok := ex.agentModules[agentName]
	if !ok {
		return nil, "", errors.New("module not found")
	}
	return module.AgentGenerate(config, listenerWM, listenerProfile)
```
